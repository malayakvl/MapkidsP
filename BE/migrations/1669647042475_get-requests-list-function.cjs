exports.shorthands = undefined;

exports.up = pgm => {
    pgm.sql(`-- DDL generated by Postico 2.0beta
-- Not all database features are supported. Do not use for backup.

CREATE OR REPLACE FUNCTION data.get_requests_list(_limit integer DEFAULT 10, _offset integer DEFAULT 0, _where json DEFAULT NULL::json, _order_by text DEFAULT ''::text)
 RETURNS TABLE(id integer, company_name character varying, company_headline character varying, logo character varying, strengths text, weaknesses text, opportunities text, threats text, threats2opportunities text, weaknesses2strengths text, color_settings text)
 LANGUAGE plpgsql
AS $function$
DECLARE
    _sql_str text := '';

    _sql_str__company_name text := '';
    _where_str text := '';
    _order_by_str text := '';
    _row_count integer := NULL;
BEGIN

    IF NOT (_limit > 0)  THEN
        _limit := 10;
    END IF;


    IF NOT (_offset >= 0)  THEN
        _offset := 0;
    END IF;


--    IF (trim(COALESCE(_where, '')) <> '') THEN
--        _where_str := ' AND ' || trim(COALESCE(_where, ''));
--    END IF;
IF ((_where->'company_name' IS NOT NULL) AND (json_typeof(_where->'company_name') = 'string') AND (_where->>'company_name' <> '')) THEN
    _sql_str__company_name := format ('
        AND (
            (lower(company_name) LIKE %1$L)
            )
        ',
        '%' || lower(_where->>'company_name') || '%'
    );
END IF;



    IF (trim(COALESCE(_order_by, '')) <> '') THEN
        _order_by_str := ' ORDER BY ' || trim(COALESCE(_order_by, ''));
    END IF;


    _sql_str := format('
        SELECT
            id, logo, company_name, company_head, strengths, weaknesses, opportunities, threats, threats2opportunities,
            weaknesses2strengths, color_settings






        FROM
            data.resources
        WHERE TRUE
            %1$s
        -- ORDER BY
        %2$s
        LIMIT %3$s OFFSET %4$s
    ',
    _sql_str__company_name, _order_by_str, _limit, _offset
    );
    -- RAISE INFO '-- %', _sql_str;
    RETURN QUERY
    EXECUTE _sql_str;


    RETURN;

END;
$function$
;`);
};

